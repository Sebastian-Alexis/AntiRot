{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col items-center gap-6 pt-6">
    <div class="text-center">
        <h1 class="text-4xl font-bold">Anti Rot</h1>
        <p class="text-gray-500 italic">Your personal brain rot blaster that lets you understand the chronically online without having to fry your own brain.</p>
    </div>
    <div class="flex gap-6 w-full max-w-4xl">
        <div class="flex flex-col items-start p-4 border rounded shadow-md bg-base-200 w-1/2">
            <h2 class="text-xl font-bold mb-2">Input</h2>
            <textarea id="inputBox" class="textarea textarea-bordered w-full" placeholder="Enter text to translate" rows="8"></textarea>
            <div class="flex items-center mt-4 gap-4">
                <button id="translateButton" class="btn btn-primary">Translate</button>
                <button id="recordButton" class="btn btn-secondary">ğŸ¤ Record</button>
            </div>
        </div>
        <div class="flex flex-col items-start p-4 border rounded shadow-md bg-base-200 w-1/2">
            <h2 class="text-xl font-bold mb-2">Output</h2>
            <div id="outputBox" class="p-4 border rounded bg-base-100 w-full h-full">Your translated text will appear here</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const recordButton = document.getElementById("recordButton");
    const inputBox = document.getElementById("inputBox");
    let mediaRecorder;
    let audioChunks = [];

    async function setupMediaRecorder() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm;codecs=opus" });

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
                console.log("Audio Blob:", audioBlob);

                if (audioBlob.size === 0) {
                    alert("The recorded audio is empty. Please try recording again.");
                    return;
                }

                const formData = new FormData();
                formData.append("audio", audioBlob);

                try {
                    const response = await fetch("/upload-audio", {
                        method: "POST",
                        body: formData,
                    });

                    const textResponse = await response.text();
                    console.log("Server Response:", textResponse);

                    const result = JSON.parse(textResponse);
                    inputBox.value = result.transcript;
                } catch (error) {
                    console.error("Error transcribing audio:", error);
                    alert("An error occurred while transcribing audio. Please check the console for details.");
                }
            };
        } catch (error) {
            console.error("Error accessing microphone:", error);
            alert("Failed to access microphone. Please check your permissions.");
        }
    }

    recordButton.addEventListener("click", async () => {
        if (!mediaRecorder) await setupMediaRecorder();

        if (mediaRecorder.state === "inactive") {
            recordButton.textContent = "ğŸ™ï¸ Stop Recording";
            audioChunks = [];
            mediaRecorder.start();
        } else {
            recordButton.textContent = "ğŸ¤ Record";
            mediaRecorder.stop();
        }
    });
</script>
{% endblock %}
